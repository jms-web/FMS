USE [FMS]
GO

SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO


ALTER VIEW [dbo].[V005_CAR_J]
AS
SELECT 
 D005.HOKOKU_NO		--報告書No
,D005.BUMON_KB		--部門区分
,isnull((SELECT ITEM_DISP FROM M001_SETTING WHERE ITEM_NAME = '部門区分' AND ITEM_VALUE=D005.BUMON_KB),'') AS BUMON_NAME	----部門区分名
,isnull((SELECT KISYU_ID FROM V002_NCR_J WHERE HOKOKU_NO = D005.HOKOKU_NO),0) AS KISYU_ID
--,isnull((SELECT KISYU FROM V002_NCR_J WHERE HOKOKU_NO = D005.HOKOKU_NO),0) AS KISYU
,isnull((SELECT KISYU_NAME FROM V002_NCR_J WHERE HOKOKU_NO = D005.HOKOKU_NO),0) AS KISYU_NAME
,D005.CLOSE_FG		--クローズフラグ
,D005.SETUMON_1		--設問内容1
,D005.KAITO_1		--設問回答1
,D005.SETUMON_2		--設問内容2
,D005.KAITO_2		--設問回答2
,D005.SETUMON_3		--設問内容3
,D005.KAITO_3		--設問回答3
,D005.SETUMON_4		--設問内容4
,D005.KAITO_4		--設問回答4
,D005.SETUMON_5		--設問内容5
,D005.KAITO_5		--設問回答5
,D005.SETUMON_6		--設問内容6
,D005.KAITO_6		--設問回答6
,D005.SETUMON_7		--設問内容7
,D005.KAITO_7		--設問回答7
,D005.SETUMON_8		--設問内容8
,D005.KAITO_8		--設問回答8
,D005.SETUMON_9		--設問内容9
,D005.KAITO_9		--設問回答9
,D005.SETUMON_10	--設問内容10
,D005.KAITO_10		--設問回答10
,D005.SETUMON_11	--設問内容11
,D005.KAITO_11		--設問回答11
,D005.SETUMON_12	--設問内容12
,D005.KAITO_12		--設問回答12
,D005.SETUMON_13	--設問内容13
,D005.KAITO_13		--設問回答13
,D005.SETUMON_14	--設問内容14
,D005.KAITO_14		--設問回答14
,D005.SETUMON_15	--設問内容15
,D005.KAITO_15		--設問回答15
,D005.SETUMON_16	--設問内容16
,D005.KAITO_16		--設問回答16
,D005.SETUMON_17	--設問内容17
,D005.KAITO_17		--設問回答17
,D005.SETUMON_18	--設問内容18
,D005.KAITO_18		--設問回答18
,D005.SETUMON_19	--設問内容19
,D005.KAITO_19		--設問回答19
,D005.SETUMON_20	--設問内容20
,D005.KAITO_20		--設問回答20
,D005.SETUMON_21	--設問内容21
,D005.KAITO_21		--設問回答21
,D005.SETUMON_22	--設問内容22
,D005.KAITO_22		--設問回答22
,D005.SETUMON_23	--設問内容23
,D005.KAITO_23		--設問回答23
,D005.SETUMON_24	--設問内容24
,D005.KAITO_24		--設問回答24
,D005.SETUMON_25	--設問内容25
,D005.KAITO_25		--設問回答25
,D005.KONPON_YOIN_KB1	--根本要因区分1
,isnull((SELECT ITEM_DISP FROM M001_SETTING WHERE ITEM_NAME = '根本要因区分' AND ITEM_VALUE=D005.KONPON_YOIN_KB1),'') AS KONPON_YOIN_NAME1	----根本要因区分1名
,D005.KONPON_YOIN_KB2	--根本要因区分2
,isnull((SELECT ITEM_DISP FROM M001_SETTING WHERE ITEM_NAME = '根本要因区分' AND ITEM_VALUE=D005.KONPON_YOIN_KB2),'') AS KONPON_YOIN_NAME2	----根本要因区分2名
,D005.KONPON_YOIN_SYAIN_ID	--根本要因社員ID
,isnull((SELECT SIMEI FROM M004_SYAIN AS M04 WHERE(M04.SYAIN_ID = D005.KONPON_YOIN_SYAIN_ID)),'') AS KONPON_YOIN_SYAIN_NAME	--根本要因社員名
,D005.KISEKI_KOTEI_KB		--帰責工程区分
,isnull((SELECT ITEM_DISP FROM M001_SETTING WHERE ITEM_NAME = '帰責工程区分' AND ITEM_VALUE=D005.KISEKI_KOTEI_KB),'') AS KISEKI_KOTEI_NAME	----帰責工程区分名
,D005.SYOCHI_A_SYAIN_ID		--処置実施A社員ID
,isnull((SELECT SIMEI FROM M004_SYAIN AS M04 WHERE(M04.SYAIN_ID = D005.SYOCHI_A_SYAIN_ID)),'') AS SYOCHI_A_SYAIN_NAME	--処置実施A社員名
,D005.SYOCHI_A_YMDHNS		--処置実施A日時
,D005.SYOCHI_B_SYAIN_ID		--処置実施B社員ID
,isnull((SELECT SIMEI FROM M004_SYAIN AS M04 WHERE(M04.SYAIN_ID = D005.SYOCHI_B_SYAIN_ID)),'') AS SYOCHI_B_SYAIN_NAME	--処置実施B社員名
,D005.SYOCHI_B_YMDHNS		--処置実施B日時
,D005.SYOCHI_C_SYAIN_ID		--処置実施C社員ID
,isnull((SELECT SIMEI FROM M004_SYAIN AS M04 WHERE(M04.SYAIN_ID = D005.SYOCHI_C_SYAIN_ID)),'') AS SYOCHI_C_SYAIN_NAME	--処置実施C社員名
,D005.SYOCHI_C_YMDHNS		--処置実施C日時
,D005.KYOIKU_FILE_PATH		--教育記録ファイルパス
,D005.ZESEI_SYOCHI_YUKO_UMU	--是正処置有効性有無
,isnull((SELECT ITEM_DISP FROM M001_SETTING WHERE ITEM_NAME = '有無区分' AND ITEM_VALUE=D005.ZESEI_SYOCHI_YUKO_UMU),'') AS ZESEI_SYOCHI_YUKO_UMU_NAME	----是正処置有効性有無
,D005.SYOSAI_FILE_PATH		--詳細資料Noファイルパス
,D005.GOKI					--号機
,D005.LOT					--LOT
,D005.KENSA_TANTO_ID		--検査社員ID
,isnull((SELECT SIMEI FROM M004_SYAIN AS M04 WHERE(M04.SYAIN_ID = D005.KENSA_TANTO_ID)),'') AS KENSA_TANTO_NAME	--検査社員名
,D005.KENSA_TOROKU_YMDHNS	--検査社員登録日時
,D005.KENSA_GL_SYAIN_ID		--検査GL社員ID
,isnull((SELECT SIMEI FROM M004_SYAIN AS M04 WHERE(M04.SYAIN_ID = D005.KENSA_GL_SYAIN_ID)),'') AS KENSA_GL_SYAIN_NAME	--検査GL社員名
,D005.KENSA_GL_YMDHNS		--検査GL社員登録日時
,D005.FILE_PATH1
,D005.FILE_PATH2
,D005.FUTEKIGO_HASSEI_YMD
,D005.SYOCHI_YOTEI_YMD
,D005.ADD_SYAIN_ID			--追加社員ID
,isnull((SELECT SIMEI FROM M004_SYAIN AS M04 WHERE(M04.SYAIN_ID = D005.ADD_SYAIN_ID)),'') AS ADD_SYAIN_NAME	--追加社員名
,D005.ADD_YMDHNS			--追加日時
,D005.UPD_SYAIN_ID			--更新社員ID
,isnull((SELECT SIMEI FROM M004_SYAIN AS M04 WHERE(M04.SYAIN_ID = D005.UPD_SYAIN_ID)),'') AS UPD_SYAIN_NAME	--更新社員名
,D005.UPD_YMDHNS			--更新日時
,D005.DEL_SYAIN_ID			--削除社員ID
,isnull((SELECT SIMEI FROM M004_SYAIN AS M04 WHERE(M04.SYAIN_ID = D005.DEL_SYAIN_ID)),'') AS DEL_SYAIN_NAME	--削除社員名
,D005.DEL_YMDHNS			--削除日時
,isnull(	
	(SELECT 
	CASE WHEN SYONIN_YMDHNS <> '' THEN UPD_SYAIN_NAME ELSE SYAIN_NAME	END FROM V003_SYONIN_J_KANRI
		 WHERE 
		     SYONIN_HOKOKUSYO_ID = 2
		 AND HOKOKU_NO	= D005.HOKOKU_NO
		 AND SYONIN_JUN = 10),'') AS SYONIN_NAME10	--CAR起草入力(10)
,isnull((SELECT SUBSTRING(SYONIN_YMDHNS,1,8) FROM V003_SYONIN_J_KANRI
		 WHERE 
		     SYONIN_HOKOKUSYO_ID = 2
		 AND HOKOKU_NO	= D005.HOKOKU_NO
		 AND SYONIN_JUN =10),'') AS SYONIN_YMD10	--CAR起草入力承認日(10)
,isnull((SELECT UPD_SYAIN_NAME FROM V003_SYONIN_J_KANRI
		 WHERE 
		     SYONIN_HOKOKUSYO_ID = 2
		 AND HOKOKU_NO	= D005.HOKOKU_NO
		 AND SYONIN_JUN = 20),'') AS SYONIN_NAME20	--起草元GL（20）
,isnull((SELECT SUBSTRING(SYONIN_YMDHNS,1,8) FROM V003_SYONIN_J_KANRI
		 WHERE 
		     SYONIN_HOKOKUSYO_ID = 2
		 AND HOKOKU_NO	= D005.HOKOKU_NO
		 AND SYONIN_JUN =20),'') AS SYONIN_YMD20	--起草元GL承認日（20）
,isnull((SELECT UPD_SYAIN_NAME FROM V003_SYONIN_J_KANRI
		 WHERE 
		     SYONIN_HOKOKUSYO_ID = 2
		 AND HOKOKU_NO	= D005.HOKOKU_NO
		 AND SYONIN_JUN = 30),'') AS SYONIN_NAME30	--担当課長（30）
,isnull((SELECT SUBSTRING(SYONIN_YMDHNS,1,8) FROM V003_SYONIN_J_KANRI
		 WHERE 
		     SYONIN_HOKOKUSYO_ID = 2
		 AND HOKOKU_NO	= D005.HOKOKU_NO
		 AND SYONIN_JUN =30),'') AS SYONIN_YMD30	--担当課長（30）
,isnull((SELECT UPD_SYAIN_NAME FROM V003_SYONIN_J_KANRI
		 WHERE 
		     SYONIN_HOKOKUSYO_ID = 2
		 AND HOKOKU_NO	= D005.HOKOKU_NO
		 AND SYONIN_JUN = 40),'') AS SYONIN_NAME40	--生技（40）
,isnull((SELECT SUBSTRING(SYONIN_YMDHNS,1,8) FROM V003_SYONIN_J_KANRI
		 WHERE 
		     SYONIN_HOKOKUSYO_ID = 2
		 AND HOKOKU_NO	= D005.HOKOKU_NO
		 AND SYONIN_JUN =40),'') AS SYONIN_YMD40	--生技（40）
,isnull((SELECT UPD_SYAIN_NAME FROM V003_SYONIN_J_KANRI
		 WHERE 
		     SYONIN_HOKOKUSYO_ID = 2
		 AND HOKOKU_NO	= D005.HOKOKU_NO
		 AND SYONIN_JUN = 50),'') AS SYONIN_NAME50	--設計（50）
,isnull((SELECT SUBSTRING(SYONIN_YMDHNS,1,8) FROM V003_SYONIN_J_KANRI
		 WHERE 
		     SYONIN_HOKOKUSYO_ID = 2
		 AND HOKOKU_NO	= D005.HOKOKU_NO
		 AND SYONIN_JUN =50),'') AS SYONIN_YMD50	--設計（50）
,isnull((SELECT UPD_SYAIN_NAME FROM V003_SYONIN_J_KANRI
		 WHERE 
		     SYONIN_HOKOKUSYO_ID = 2
		 AND HOKOKU_NO	= D005.HOKOKU_NO
		 AND SYONIN_JUN = 60),'') AS SYONIN_NAME60	--検査員（60）
,isnull((SELECT SUBSTRING(SYONIN_YMDHNS,1,8) FROM V003_SYONIN_J_KANRI
		 WHERE 
		     SYONIN_HOKOKUSYO_ID = 2
		 AND HOKOKU_NO	= D005.HOKOKU_NO
		 AND SYONIN_JUN =60),'') AS SYONIN_YMD60	--検査員（60）
,isnull((SELECT UPD_SYAIN_NAME FROM V003_SYONIN_J_KANRI
		 WHERE 
		     SYONIN_HOKOKUSYO_ID = 2
		 AND HOKOKU_NO	= D005.HOKOKU_NO
		 AND SYONIN_JUN = 70),'') AS SYONIN_NAME70	--品証課長（70）
,isnull((SELECT SUBSTRING(SYONIN_YMDHNS,1,8) FROM V003_SYONIN_J_KANRI
		 WHERE 
		     SYONIN_HOKOKUSYO_ID = 2
		 AND HOKOKU_NO	= D005.HOKOKU_NO
		 AND SYONIN_JUN =70),'') AS SYONIN_YMD70	--品証課長（70）
,isnull((SELECT UPD_SYAIN_NAME FROM V003_SYONIN_J_KANRI
		 WHERE 
		     SYONIN_HOKOKUSYO_ID = 2
		 AND HOKOKU_NO	= D005.HOKOKU_NO
		 AND SYONIN_JUN = 90),'') AS SYONIN_NAME90	--担当課長（90）
,isnull((SELECT SUBSTRING(SYONIN_YMDHNS,1,8) FROM V003_SYONIN_J_KANRI
		 WHERE 
		     SYONIN_HOKOKUSYO_ID = 2
		 AND HOKOKU_NO	= D005.HOKOKU_NO
		 AND SYONIN_JUN =90),'') AS SYONIN_YMD90	--担当課長（90）
,isnull((SELECT UPD_SYAIN_NAME FROM V003_SYONIN_J_KANRI
		 WHERE 
		     SYONIN_HOKOKUSYO_ID = 2
		 AND HOKOKU_NO	= D005.HOKOKU_NO
		 AND SYONIN_JUN = 100),'') AS SYONIN_NAME100	--検査員（100）
,isnull((SELECT SUBSTRING(SYONIN_YMDHNS,1,8) FROM V003_SYONIN_J_KANRI
		 WHERE 
		     SYONIN_HOKOKUSYO_ID = 2
		 AND HOKOKU_NO	= D005.HOKOKU_NO
		 AND SYONIN_JUN =100),'') AS SYONIN_YMD100	--検査員（100）
,isnull((SELECT UPD_SYAIN_NAME FROM V003_SYONIN_J_KANRI
		 WHERE 
		     SYONIN_HOKOKUSYO_ID = 2
		 AND HOKOKU_NO	= D005.HOKOKU_NO
		 AND SYONIN_JUN = 120),'') AS SYONIN_NAME120	--品証TL確認（120）
,isnull((SELECT SUBSTRING(SYONIN_YMDHNS,1,8) FROM V003_SYONIN_J_KANRI
		 WHERE 
		     SYONIN_HOKOKUSYO_ID = 2
		 AND HOKOKU_NO	= D005.HOKOKU_NO
		 AND SYONIN_JUN =120),'') AS SYONIN_YMD120	--品証TL確認（120）

--Add 20180829
,isnull((SELECT UPD_SYAIN_NAME FROM V003_SYONIN_J_KANRI
		 WHERE 
		     SYONIN_HOKOKUSYO_ID = 2
		 AND HOKOKU_NO	= D005.HOKOKU_NO
		 AND SYONIN_JUN = 130),'') AS SYONIN_NAME130	--確認（130）
,isnull((SELECT SUBSTRING(SYONIN_YMDHNS,1,8) FROM V003_SYONIN_J_KANRI
		 WHERE 
		     SYONIN_HOKOKUSYO_ID = 2
		 AND HOKOKU_NO	= D005.HOKOKU_NO
		 AND SYONIN_JUN =130),'') AS SYONIN_YMD130	--確認（130）
,isnull((SELECT SURYO FROM V002_NCR_J WHERE HOKOKU_NO = D005.HOKOKU_NO),0) AS SURYO
FROM D005_CAR_J AS D005
		  

GO


